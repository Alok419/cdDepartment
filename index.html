<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI OASIS Analyzer</title>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b1f2a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
    }

    .card {
        width: 480px;
        background: #081821;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 20px 50px rgba(0,0,0,.45);
        margin: 20px 0;
    }

    h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-weight: 600;
        text-align: center;
    }

    p {
        font-size: 14px;
        opacity: 0.85;
        text-align: center;
        margin-bottom: 20px;
    }

    input[type="file"], input[type="password"] {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed #4fa3ff;
        background: #06141c;
        color: #fff;
        cursor: pointer;
        box-sizing: border-box;
        margin-bottom: 10px;
    }
    
    input[type="password"] {
        cursor: text;
        border: 1px solid #333;
    }

    button {
        margin-top: 10px;
        width: 100%;
        padding: 12px;
        background: #4fa3ff;
        border: none;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.3s;
    }

    button:hover {
        background: #7abaff;
    }

    button:disabled {
        background: #6b6b6b;
        cursor: not-allowed;
    }

    /* Green Save Button style */
    .save-btn {
        background: #4cff9f;
        color: #000;
        margin-top: 10px;
    }
    .save-btn:hover {
        background: #7dfcbd;
    }

    .status {
        margin-top: 16px;
        font-size: 14px;
        min-height: 20px;
        text-align: center;
    }

    .success {
        color: #4cff9f;
    }

    .error {
        color: #ff7a7a;
    }

    /* JSON Preview Area Styles */
    #resultArea {
        display: none;
        margin-top: 20px;
        border-top: 1px solid #1f3a4d;
        padding-top: 15px;
    }

    textarea {
        width: 100%;
        height: 250px;
        background: #050e13;
        color: #a6e22e;
        border: 1px solid #1f3a4d;
        border-radius: 6px;
        padding: 10px;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
    }

    label {
        font-size: 12px;
        color: #aaa;
        display: block;
        margin-bottom: 5px;
    }
</style>
</head>

<body>

<div class="card">
    <h2>AI OASIS Analyzer</h2>
    <p>Upload OASIS document to extract data</p>

    <label>Gemini API Key (Paste here for testing):</label>
    <input type="password" id="apiKeyInput" placeholder="Paste AIza... key here" />

    <label style="margin-top:10px;">Select Document:</label>
    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />

    <button id="analyzeBtn" onclick="startAnalysis()">
        Analyze Document
    </button>

    <div id="status" class="status"></div>

    <div id="resultArea">
        <label>Review AI Extraction Result:</label>
        <textarea id="jsonOutput"></textarea>
        
        <button id="saveBtn" class="save-btn" onclick="finalizeSave()">
            Save to Salesforce
        </button>
    </div>
</div>

<script>
/* =========================================================
   CONFIGURATION
   ========================================================= */

// Updated to stable model to avoid 404 errors
const GEMINI_ENDPOINT =
    "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent";

// ğŸ”´ Replace with your Salesforce domain
const SALESFORCE_ENDPOINT =
    "https://codingdepartment--pcopy.sandbox.my.salesforce.com/services/apexrest/oasis/ai-result";

// ğŸ”´ POC ONLY â€” use session id or access token
const SALESFORCE_AUTH =
"Bearer 00DWB000000B4YB2A0!AQEAQJbGuC_UEOJ4LQm5zeAtSVcotBBMiMnF6yVFFNohNXyJHUq.dYhkjkkSEolqRlJ0mzbEBZeB.ShxBxTyejyKyA_M7yoK";


/* =========================================================
   SALESFORCE CONTEXT (AUTOMATIC RECORD ID)
   ========================================================= */

let CHART_ID = null;
let CACHED_AI_TIME = 0;

// Receive recordId securely from Salesforce LWC
const ALLOWED_ORIGINS = [
    "https://codingdepartment--pcopy.sandbox.lightning.force.com",
    "https://codingdepartment--pcopy.sandbox.my.salesforce.com"
];

window.addEventListener("message", (event) => {
    if (!ALLOWED_ORIGINS.some(origin => event.origin.startsWith(origin))) {
        return;
    }
    if (event.data && event.data.type === "SF_CONTEXT") {
        CHART_ID = event.data.recordId;
        console.log("âœ… Chart Id received:", CHART_ID);
    }
});


/* =========================================================
   MAIN FLOW
   ========================================================= */

async function startAnalysis() {
    const status = document.getElementById("status");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultArea = document.getElementById("resultArea");
    const jsonOutput = document.getElementById("jsonOutput");
    const file = document.getElementById("fileInput").files[0];
    
    // NEW: Get API Key from Input
    const apiKey = document.getElementById("apiKeyInput").value.trim();

    // Reset UI
    resultArea.style.display = "none";
    jsonOutput.value = "";
    
    if (!CHART_ID) {
        showStatus("âŒ Salesforce record context not loaded", true);
        return;
    }

    if (!apiKey) {
        showStatus("âŒ Please enter a Gemini API Key", true);
        return;
    }

    if (!file) {
        showStatus("âŒ Please select a file", true);
        return;
    }

    try {
        analyzeBtn.disabled = true;
        showStatus("Reading file...");
        
        const base64Data = await readFileAsBase64(file);

        showStatus("Running AI analysis...");
        const startTime = Date.now();
        
        // Pass apiKey to the function
        const rawResult = await callGemini(apiKey, file.type, base64Data);
        
        // Calculate and cache time
        CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

        // Try to pretty print the JSON
        let prettyJson = rawResult;
        try {
            // Clean markdown block if present ```json ... ```
            const cleanJson = rawResult.replace(/```json/g, "").replace(/```/g, "").trim();
            const parsed = JSON.parse(cleanJson);
            prettyJson = JSON.stringify(parsed, null, 4);
        } catch (e) {
            console.warn("Could not pretty print JSON, showing raw text.");
        }

        // Display results
        jsonOutput.value = prettyJson;
        resultArea.style.display = "block";
        analyzeBtn.disabled = false;
        
        showStatus("âœ… Analysis complete. Please review data below.", false);

    } catch (error) {
        console.error(error);
        showStatus("âŒ " + error.message, true);
        analyzeBtn.disabled = false;
    }
}

async function finalizeSave() {
    const saveBtn = document.getElementById("saveBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    const finalJson = jsonOutput.value; // Get (possibly edited) value

    if (!finalJson) {
        showStatus("âŒ No data to save", true);
        return;
    }

    try {
        saveBtn.disabled = true;
        saveBtn.innerText = "Saving...";
        showStatus("Saving results to Salesforce...");

        await sendToSalesforce(finalJson, CACHED_AI_TIME);

        showStatus("âœ… Saved successfully to Salesforce!", false);
        saveBtn.innerText = "Saved";
        
        setTimeout(() => {
             saveBtn.disabled = false;
             saveBtn.innerText = "Save to Salesforce";
        }, 3000);

    } catch (error) {
        console.error(error);
        showStatus("âŒ Save failed: " + error.message, true);
        saveBtn.disabled = false;
        saveBtn.innerText = "Save to Salesforce";
    }
}

/* =========================================================
   HELPER FUNCTIONS
   ========================================================= */

function showStatus(message, isError = false) {
    const status = document.getElementById("status");
    status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Updated function signature to accept apiKey
async function callGemini(apiKey, mimeType, base64Data) {

    const instructions = `
You are a specialized Clinical Document Extractor.

Your task is to extract data from an OASIS-E1 Home Health Assessment document (PDF or image).
This is a VISUAL extraction task. Use layout, checkboxes, symbols, and circled values â€” not text order.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VISUAL IDENTIFICATION RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. A value is SELECTED only if you see:
   â˜‘  [X]  â–   âœ”  or a circled number
2. Ignore unchecked boxes: â˜  [ ]
3. If multiple boxes are selected, extract ALL selected values.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CRITICAL FORMATTING RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. RETURN ONLY VALID JSON
2. Return ONE flat JSON object
3. ALL values must be STRINGS
4. NO markdown, NO explanations, NO backticks
5. If a value is not found or not selected â†’ return "N/A"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NUMERIC NORMALIZATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Remove leading zeros:
  "01" â†’ "1", "02" â†’ "2"
â€¢ EXCEPTION: GG items MUST KEEP leading zeros
  Example: "06", "05", "01"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATE RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Format all dates as: YYYY-MM-DD
â€¢ If date is missing â†’ "N/A"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MULTI-SELECT RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ If multiple items are selected â†’ return comma-separated values
  Example: "1,2,4"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OASIS ITEMS TO EXTRACT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

--- CHART DATA ---
M0030  Start of Care Date â†’ YYYY-MM-DD
M0032  Resumption of Care Date â†’ YYYY-MM-DD
M0060  ZIP Code â†’ FIRST 5 DIGITS ONLY
M0110  Episode Timing â†’ "1" (Early) or "2" (Later)
M0069  Gender â†’ "1" Male, "2" Female
M0080  Discipline â†’ 
        "1" RN
        "2" PT
        "3" SLP/ST
        "4" OT
M1005  Inpatient Discharge Date â†’ YYYY-MM-DD

--- OASIS CORE ITEMS ---
M0090  Date Assessment Completed
M1000  Inpatient Discharge History (1â€“7, multi-select)
M1033  Risk for Hospitalization (multi-select)
B1000  Vision
M1400  Dyspnea
M1700  Cognitive Functioning
M1710  When Confused
M1720  When Anxious
M1740  Cognitive/Behavioral Symptoms (multi-select)
M1745  Disruptive Behavior
M1800  Grooming
M1810  Upper Body Dressing
M1820  Lower Body Dressing
M1830  Bathing
M1840  Toilet Transfer
M1845  Toileting Hygiene
M1850  Transferring
M1860  Ambulation
M1870  Feeding
M2020  Oral Medications
J0530  Pain Interference

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GG ITEMS (KEEP LEADING ZEROS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Extract SOC/ROC PERFORMANCE codes ONLY:

GG0130 B  Oral Hygiene
GG0130 C  Toileting Hygiene
GG0130 E  Shower/Bathe Self
GG0130 F  Upper Body Dressing
GG0130 G  Lower Body Dressing
GG0130 H  Footwear

GG0170 A  Roll Left/Right
GG0170 B  Sit to Lying
GG0170 C  Lying to Sitting
GG0170 D  Sit to Stand
GG0170 E  Chair/Bed Transfer
GG0170 F  Toilet Transfer
GG0170 I  Walk 10 Feet
GG0170 J  Walk 50 Feet w/ Turns
GG0170 K  Walk 150 Feet
GG0170 L  Walk 10 Feet Uneven
GG0170 M  1 Step / Curb
GG0170 N  4 Steps
GG0170 O  12 Steps
GG0170 R  Wheel 50 Feet
GG0170 S  Wheel 150 Feet

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
D0150 PATIENT MOOD INTERVIEW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Two columns per row.

Row A â€“ Little interest or pleasure:
â€¢ Column 1 â†’ Symptom Presence (0â€“3)
â€¢ Column 2 â†’ Symptom Frequency (0â€“3)

Row B â€“ Feeling down/depressed:
â€¢ Column 1 â†’ Symptom Presence (0â€“3)
â€¢ Column 2 â†’ Symptom Frequency (0â€“3)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PLAN OF CARE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Activities Permitted:
Return ONLY these labels (comma-separated):
Complete Bed Rest,
Up as Tolerated,
Exercise Prescribed,
Independent at Home,
Cane,
Walker,
Bed Rest BRP,
Transfer Bed-Chair,
Partial Weight Bearing,
Crutches,
Wheelchair,
Other,
Needs assist with ADLs,
Transfer Assistance,
Fall Precautions,
Slow Position Changes,
Wound Care,
Abdominal Surgery Precautions,
Requires Supervision

DME:
Return ONLY these labels (comma-separated):
Bedside Commode,
Cane,
Elevated Toilet Seat,
Grab Bars,
Hospital Bed,
Nebulizer,
Oxygen,
Tub/Shower Bench,
Walker,
Wheelchair,
Other,
Bed Overlay,
Brace/Orthotics,
Crutches,
Hoyer Lift,
Respiratory Equipment,
Slider Board,
Trapeze,
No-DME,
CPAP Machine,
Diabetic Supplies,
Vital Sign Equipment,
Removable Shower Head,
Scooter,
Wound Care Supplies,
Alcohol/Hand Sanitizer,
Lab Supplies, PPE

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FINAL SALESFORCE JSON KEYS (MANDATORY)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Use EXACTLY these keys â€” do NOT add or remove any:

SOC_Date
ROC_Date
Zip_Code
Episode_Timing
M0069
M0080
Inpatient_Discharge_Date
M0090_Date_Assessment_Completed
M1000_Discharge_History
Activities_Permitted__c
DME_Supplies__c
M1200_Vision__c
Little_interest_symptom_presence__c
Little_interest_symptom_frequency__c
Feeling_down_symptom_presence__c
Feeling_down_symptom_frequency__c
Functional_Points_M1033__c
M1400_SOB_Actual__c
M1700_Cognitive_Functioning__c
M1710_When_Confused__c
M1720_When_Anxious__c
M1740_Cognitive_behavioral_and__c
M1745_Frequncy_of_Disruptive_Behavior__c
M1800_Grooming_Actual__c
M1810_Ability_to_Dress_Upper_Body_Actual__c
M1820_Ability_to_Dress_Lower_Body_Actual__c
M1830_Bathing_Actual__c
M1840_Toilet_Transferring_Actual__c
M1845_Toilet_Hyg_Actual__c
M1850_Transferring_Actual__c
M1860_Ambulation_Locomotion_Actual__c
M1870_Feeding_Actual__c
M2020_Oral_Medications_Actual__c
J0530_Pain_Interference_with_Day_to_Da__c

GG0130_B_Oral_Hygiene__c
GG0130_C_Toileting_Hygiene__c
GG0130_E_Shower_bathe_self__c
GG0130_F_Upper_body_dressing__c
GG0130_G_Lower_body_dressing__c
GG0130_H_Putting_on_taking_off_footwear__c

GG0170_A_Roll_left_and_right__c
GG0170_B_Sit_to_lying__c
GG0170_C_Lying_to_sitting_on_side_of_bed__c
GG0170_D_Sit_to_stand__c
GG0170_E_Chair_bed_to_chair_transfer__c
GG0170_F_Toilet_transfer__c
GG0170_I_Walk_10_feet__c
GG0170_J_Walk_50_feet_with_two_turns__c
GG0170_K_Walk_150_feet__c
GG0170_L_Walking_10_feet_on_uneven_surf__c
GG0170_M_1_step_curb__c
GG0170_N_4_steps__c
GG0170_O_12_steps__c
GG0170_R_Wheel_50_feet_with_two_turns__c
GG0170_S_Wheel_150_feet__c

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FINAL OUTPUT RULE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Return ONLY the JSON object.
No text before or after.
If something is missing â†’ "N/A".

`;

    const response = await fetch(
        `${GEMINI_ENDPOINT}?key=${apiKey}`, // Uses the key from the input
        {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: instructions },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }]
            })
        }
    );

    if (!response.ok) {
        // Log detailed error for debugging
        const errText = await response.text();
        console.error("Gemini API Error:", errText);
        throw new Error("Gemini API call failed: " + response.statusText);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

async function sendToSalesforce(rawJson, aiTimeSeconds) {

    const response = await fetch(SALESFORCE_ENDPOINT, {
        method: "POST",
        headers: {
            "Authorization": SALESFORCE_AUTH,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            chartId: CHART_ID,
            rawJson: rawJson,
            aiTimeSeconds: aiTimeSeconds
        })
    });

    if (!response.ok) {
        const text = await response.text();
        throw new Error("Salesforce save failed: " + text);
    }
}
</script>

</body>
</html>
